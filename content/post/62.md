+++
date = "2016-12-19T15:59:13+09:00"
draft = false
tags = ["Mac", "Python", "virtualenv"]
title = "Python 3 をインストールして virtualenv で環境を設定する"

+++

Machine Intelligence な [TensorFlow](https://www.tensorflow.org) を使ってみたくて、その前に Python をインストールして、使えるところまで調べてみました。

<!--more-->

## 環境

* macOS Sierra バージョン 10.12.3
* Python 3.6.0
* pip 9.0.1
* virtualenv 15.1.0

## Python 3 のインストール

Mac には標準で Python 2.7.10 がインストールされているようなのですが、最新版は Python 3 のようですので、Python 3 をインストールすることにしました。
まだ Python 2 でしか動かない有用なライブラリーがあるらしいことも認識して、Python 3 を使おうと思いました。

> 現在は Python 3 が最新版の Python ですが、 Python 2 もまだ活発に利用されています。なのであなたのプロジェクトを両方のメジャーリリースにおいて動作可能にしておくのがよいでしょう。このガイドでは、 Python 2 と 3 を同時にサポートするにはどうすればよいかを解説します。
>
> ...略...
>
> コア開発者の視点から Python3 が世に出てきたが理由を読みたい場合は、 Nick Coghlan の [Python 3 Q & A](https://ncoghlan-devs-python-notes.readthedocs.org/en/latest/python3/questions_and_answers.html) または [Brett Cannonによる \`Why Python 3 exists](http://www.snarky.ca/why-python-3-exists) がおすすめです。
>
> <cite>[Python 2 から Python 3 への移植 — Python 3.6.1 ドキュメント](https://docs.python.jp/3/howto/pyporting.html)</cite>

Python のサイトでは Mac に Python をインストールする際にはインストーラをダウンロードしてインストールするように記載されているようです。

> 4.1. MacPython の入手とインストール(原文)
>
> Mac OS X 10.8 には Apple によって Python 2.7 がプリインストールされています。Python の Web サイト (https://www.python.org) から最新バージョンの Python 3 を取得しインストールすることもできます。新しい Intel の CPU でも古い PPC の CPU でもネイティブに動作する “ユニバーサル・バイナリ” ビルドの最新のものがあります。
>
> <cite>[4. Macintosh で Python を使う — Python 3.6.1 ドキュメント](https://docs.python.jp/3/using/mac.html)</cite>

が、[Homebrew](http://brew.sh/index_ja.html) にもあるようなので、Homebrew からインストールしてみました。

Homebrew は前にインストールしておいたものです。

* [Homebrewのインストール]({{< relref "2.md" >}})

Homebrew で python を検索してみます。

``` bash
$ brew search python
app-engine-python          micropython                python3
boost-python               python                     wxpython
gst-python                 python-markdown            zpython
homebrew/apache/mod_python               Caskroom/cask/kk7ds-python-runtime
homebrew/python/vpython                  Caskroom/cask/mysql-connector-python
```

python3 がそれかな。

Python 3 をインストールします。

``` bash
$ brew install python3
==> Installing dependencies for python3: readline, sqlite, gdbm, xz
==> Installing python3 dependency: readline
==> Downloading https://homebrew.bintray.com/bottles/readline-7.0.1.sierra.bottl
######################################################################## 100.0%
==> Pouring readline-7.0.1.sierra.bottle.tar.gz
==> Caveats
This formula is keg-only, which means it was not symlinked into /usr/local.

macOS provides the BSD libedit library, which shadows libreadline.
In order to prevent conflicts when programs look for libreadline we are
defaulting this GNU Readline installation to keg-only.


Generally there are no consequences of this for you. If you build your
own software and it requires this formula, you'll need to add to your
build variables:

    LDFLAGS:  -L/usr/local/opt/readline/lib
    CPPFLAGS: -I/usr/local/opt/readline/include

==> Summary
🍺  /usr/local/Cellar/readline/7.0.1: 46 files, 2M
==> Installing python3 dependency: sqlite
==> Downloading https://homebrew.bintray.com/bottles/sqlite-3.16.2.sierra.bottle
######################################################################## 100.0%
==> Pouring sqlite-3.16.2.sierra.bottle.tar.gz
==> Caveats
This formula is keg-only, which means it was not symlinked into /usr/local.

macOS provides an older sqlite3.

Generally there are no consequences of this for you. If you build your
own software and it requires this formula, you'll need to add to your
build variables:

    LDFLAGS:  -L/usr/local/opt/sqlite/lib
    CPPFLAGS: -I/usr/local/opt/sqlite/include

==> Summary
🍺  /usr/local/Cellar/sqlite/3.16.2: 11 files, 2.9M
==> Installing python3 dependency: gdbm
==> Downloading https://homebrew.bintray.com/bottles/gdbm-1.12.sierra.bottle.tar
######################################################################## 100.0%
==> Pouring gdbm-1.12.sierra.bottle.tar.gz
🍺  /usr/local/Cellar/gdbm/1.12: 18 files, 486.9K
==> Installing python3 dependency: xz
==> Downloading https://homebrew.bintray.com/bottles/xz-5.2.2.sierra.bottle.tar.
######################################################################## 100.0%
==> Pouring xz-5.2.2.sierra.bottle.tar.gz
🍺  /usr/local/Cellar/xz/5.2.2: 91 files, 1.4M
==> Installing python3
==> Downloading https://homebrew.bintray.com/bottles/python3-3.6.0.sierra.bottle
######################################################################## 100.0%
==> Pouring python3-3.6.0.sierra.bottle.tar.gz
==> Using the sandbox
==> /usr/local/Cellar/python3/3.6.0/bin/python3 -s setup.py --no-user-cfg instal
==> /usr/local/Cellar/python3/3.6.0/bin/python3 -s setup.py --no-user-cfg instal
==> /usr/local/Cellar/python3/3.6.0/bin/python3 -s setup.py --no-user-cfg instal
==> Caveats
Pip, setuptools, and wheel have been installed. To update them
  pip3 install --upgrade pip setuptools wheel

You can install Python packages with
  pip3 install <package>

They will install into the site-package directory
  /usr/local/lib/python3.6/site-packages

See: http://docs.brew.sh/Homebrew-and-Python.html

.app bundles were installed.
Run `brew linkapps python3` to symlink these to /Applications.
==> Summary
🍺  /usr/local/Cellar/python3/3.6.0: 3,597 files, 55.7M
```

readline, sqlite, gdbm, xz のパッケージに依存しているようで、一緒にインストールされたようでした。

`python3` コマンドで Python 3 が使えるようです。
Mac は標準で Python 2 がインストールされていて、`python` コマンドで Python 2 が使えるということのようです。

``` bash
$ python3 --version
Python 3.6.0
$ which python3
/usr/local/bin/python3
```

3.6.0 がインストールされていることが確認できました。

Python 3 をインストールした直後のパッケージは次のようになっていました。

``` bash
$ pip3 list --format=columns
Package    Version
---------- -------
pip        9.0.1
setuptools 32.2.0
wheel      0.29.0
$ ls /usr/local/lib/python3.6/site-packages/
__pycache__				setuptools
easy_install.py				setuptools-32.2.0-py3.6.egg-info
pip					sitecustomize.py
pip-9.0.1-py3.6.egg-info		wheel
pkg_resources				wheel-0.29.0-py3.6.egg-info
```

pip, setuptools, wheel の 3 つのパッケージが標準であるようです。

## virtualenv のインストール

virtualenv はプロジェクトごとに分離してパッケージを管理するためのツールのようです。

> * `venv` is the standard tool for creating virtual environments, and has been part of Python since Python 3.3. Starting with Python 3.4, it defaults to installing pip into all created virtual environments.
> * `virtualenv` is a third party alternative (and predecessor) to `venv`. It allows virtual environments to be used on versions of Python prior to 3.4, which either don’t provide `venv` at all, or aren’t able to automatically install `pip` into created environments.
>
> ...略...
>
> バージョン 3.6 で撤廃: `pyvenv` was the recommended tool for creating virtual environments for Python 3.3 and 3.4, and is deprecated in Python 3.6.
> バージョン 3.5 で変更: The use of `venv` is now recommended for creating virtual environments.
>
> <cite>[Python モジュールのインストール — Python 3.6.1 ドキュメント](http://docs.python.jp/3/installing/)</cite>

Python のサイトでは `venv` を標準のツールと記載しています。
`virtualenv` はサードパーティー的な記載があります。
Google トレンドで比較すると圧倒的に `virtualenv` が多かったので、`virtualenv` が事実上の標準なのでしょうか。

`pyvenv` は 3.6 で撤廃らしいです。
この `pyvenv` は `pyenv` とは違うみたいです。

<!-- > Introduction
>
> `virtualenv` is a tool to create isolated Python environments.
>
> <cite>[Virtualenv — virtualenv 15.1.0 documentation](https://virtualenv.pypa.io/en/stable/)</cite> -->

virtualenv 自体もパッケージとしてあるようですが、パッケージのインストールには pip を使うようです。

> * `pip` は推奨されるインストーラ・プログラムです。 Python 3.4 からは、 Python バイナリ・インストーラに最初から付属するようになりました。
>
> <cite>[Python モジュールのインストール — Python 3.6.1 ドキュメント](http://docs.python.jp/3/installing/)</cite>

virtualenv をインストールします。
Python 3 なので、pip も `pip3` コマンドとなるようです。

``` bash
$ pip3 install virtualenv
Collecting virtualenv
  Downloading virtualenv-15.1.0-py2.py3-none-any.whl (1.8MB)
    100% |████████████████████████████████| 1.8MB 421kB/s
Installing collected packages: virtualenv
Successfully installed virtualenv-15.1.0
```

パッケージを確認します。

``` bash
$ pip3 list --format=columns
Package    Version
---------- -------
pip        9.0.1
setuptools 32.2.0
virtualenv 15.1.0
wheel      0.29.0
$ ls /usr/local/lib/python3.6/site-packages/
__pycache__				sitecustomize.py
easy_install.py				virtualenv-15.1.0.dist-info
pip					virtualenv.py
pip-9.0.1-py3.6.egg-info		virtualenv_support
pkg_resources				wheel
setuptools				wheel-0.29.0-py3.6.egg-info
setuptools-32.2.0-py3.6.egg-info
```

virtualenv がインストールされていることが確認できました。

## virtualenv の環境を作る

`virtualenv` コマンドにディレクトリーの名前を渡せばよさそうです。

> Usage
>
> Virtualenv has one basic command:
>
> ``` bash
$ virtualenv ENV
```
>
> Where `ENV` is a directory to place the new virtual environment.
>
> <cite>[User Guide — virtualenv 15.1.0 documentation](https://virtualenv.pypa.io/en/stable/userguide/#using-virtualenv-without-bin-python)</cite>

実行してみます。

``` bash
$ virtualenv ENV
Using base prefix '/usr/local/Cellar/python3/3.6.0_1/Frameworks/Python.framework/Versions/3.6'
New python executable in /Users/user/ENV/bin/python3.6
Also creating executable in /Users/user/ENV/bin/python
Installing setuptools, pip, wheel...done.
```

`ENV` という名前のディレクトリーにしてみました。
このディレクトリーはあっても、なくても "よき" に計らってくれるみたいです。
今回はディレクトリーがない状態で実行してみました。

ディレクトリーに移動して、中を見てみます。

``` bash
$ cd ENV
$ ls
bin			lib
include			pip-selfcheck.json
```

bin, lib, include のディレクトリーと、pip-selfcheck.json ファイルが作成されたみたいです。

## virtualenv の環境を有効にする

virtualenv の環境を有効にするには、ディレクトリーの中の `bin/activate` を実行するようです。

> activate script
>
> In a newly created virtualenv there will also be a activate shell script. For Windows systems, activation scripts are provided for the Command Prompt and Powershell.
>
> On Posix systems, this resides in /ENV/bin/, so you can run:
>
> ``` bash
$ source bin/activate
```
>
> <cite>[User Guide — virtualenv 15.1.0 documentation](https://virtualenv.pypa.io/en/stable/userguide/)</cite>

実行してみます。

``` bash
$ source bin/activate
(ENV) $
```

virtualenv の環境を有効にすると、プロンプトに `(ディレクトリーの名前)` がつくみたいです。

最初に入っているパッケージは次の通りでした。

``` bash
(ENV) $ pip3 list --format=columns
Package    Version
---------- -------
appdirs    1.4.3
packaging  16.8
pip        9.0.1
pyparsing  2.2.0
setuptools 34.3.2
six        1.10.0
wheel      0.29.0
(ENV) $ ls -l lib/python3.6/site-packages/
total 584
drwxr-xr-x   6 user  staff     204  3 23 14:32 __pycache__
drwxr-xr-x   9 user  staff     306  3 23 14:32 appdirs-1.4.3.dist-info
-rw-r--r--   1 user  staff   24701  3 23 14:32 appdirs.py
-rw-r--r--   1 user  staff     126  3 23 14:32 easy_install.py
drwxr-xr-x  12 user  staff     408  3 23 14:32 packaging
drwxr-xr-x   9 user  staff     306  3 23 14:32 packaging-16.8.dist-info
drwxr-xr-x  23 user  staff     782  3 23 14:32 pip
drwxr-xr-x  10 user  staff     340  3 23 14:32 pip-9.0.1.dist-info
drwxr-xr-x   4 user  staff     136  3 23 14:32 pkg_resources
drwxr-xr-x   9 user  staff     306  3 23 14:32 pyparsing-2.2.0.dist-info
-rw-r--r--   1 user  staff  231039  3 23 14:32 pyparsing.py
drwxr-xr-x  37 user  staff    1258  3 23 14:32 setuptools
drwxr-xr-x  12 user  staff     408  3 23 14:32 setuptools-34.3.2.dist-info
drwxr-xr-x   9 user  staff     306  3 23 14:32 six-1.10.0.dist-info
-rw-r--r--   1 user  staff   30098  3 23 14:32 six.py
drwxr-xr-x  20 user  staff     680  3 23 14:32 wheel
drwxr-xr-x  11 user  staff     374  3 23 14:32 wheel-0.29.0.dist-info
```

`bin/activate` で何をしているかというと、`$PATH` の環境変数の先頭に `bin/` を挿入しているようです。
こうすることでこのディレクトリーの中のコマンドが優先されることになるようです。

> This will change your `$PATH` so its first entry is the virtualenv’s `bin/` directory. (You have to use `source` because it changes your shell environment in-place.) This is all it does; it’s purely a convenience. If you directly run a script or the python interpreter from the virtualenv’s `bin/` directory (e.g. `path/to/ENV/bin/pip` or `/path/to/ENV/bin/python-script.py`) there’s no need for activation.
>
> <cite>[User Guide — virtualenv 15.1.0 documentation](https://virtualenv.pypa.io/en/stable/userguide/)</cite>

環境変数の `$PATH` を比べてみます。

``` bash
# virtualenv が無効の場合
$ echo $PATH
/Users/user/.nodebrew/current/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:./node_modules/.bin:/usr/local/opt/go/libexec/bin:/Users/user/go/bin
```

``` bash
# virtualenv が有効の場合
(ENV) $ echo $PATH
/Users/user/ENV/bin:/Users/user/.nodebrew/current/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:./node_modules/.bin:/usr/local/opt/go/libexec/bin:/Users/user/go/bin
```

`bin/` が先頭に挿入されていました。

## virtualenv の環境でパッケージをインストールする

virtualenv の中で NumPy パッケージをインストールしてみます。

> NumPy is the fundamental package for scientific computing with Python.
>
> <cite>[NumPy — NumPy](http://www.numpy.org)</cite>

virtualenv の環境でもパッケージのインストールは pip です。
また `pip3` コマンドでインストールします。

``` bash
(ENV) $ pip3 install numpy
Collecting numpy
  Downloading numpy-1.12.1-cp36-cp36m-macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64.macosx_10_10_intel.macosx_10_10_x86_64.whl (4.4MB)
    100% |████████████████████████████████| 4.4MB 242kB/s
Installing collected packages: numpy
Successfully installed numpy-1.12.1
```

パッケージを確認します。

``` bash
(ENV) $ pip3 list --format=columns
Package    Version
---------- -------
appdirs    1.4.3
numpy      1.12.1
packaging  16.8
pip        9.0.1
pyparsing  2.2.0
setuptools 34.3.2
six        1.10.0
wheel      0.29.0
(ENV) $ ls -l lib/python3.6/site-packages/
total 584
drwxr-xr-x   6 user  staff     204  3 23 14:32 __pycache__
drwxr-xr-x   9 user  staff     306  3 23 14:32 appdirs-1.4.3.dist-info
-rw-r--r--   1 user  staff   24701  3 23 14:32 appdirs.py
-rw-r--r--   1 user  staff     126  3 23 14:32 easy_install.py
drwxr-xr-x  28 user  staff     952  3 23 19:46 numpy
drwxr-xr-x   9 user  staff     306  3 23 19:46 numpy-1.12.1.dist-info
drwxr-xr-x  12 user  staff     408  3 23 14:32 packaging
drwxr-xr-x   9 user  staff     306  3 23 14:32 packaging-16.8.dist-info
drwxr-xr-x  23 user  staff     782  3 23 14:32 pip
drwxr-xr-x  10 user  staff     340  3 23 14:32 pip-9.0.1.dist-info
drwxr-xr-x   4 user  staff     136  3 23 14:32 pkg_resources
drwxr-xr-x   9 user  staff     306  3 23 14:32 pyparsing-2.2.0.dist-info
-rw-r--r--   1 user  staff  231039  3 23 14:32 pyparsing.py
drwxr-xr-x  37 user  staff    1258  3 23 14:32 setuptools
drwxr-xr-x  12 user  staff     408  3 23 14:32 setuptools-34.3.2.dist-info
drwxr-xr-x   9 user  staff     306  3 23 14:32 six-1.10.0.dist-info
-rw-r--r--   1 user  staff   30098  3 23 14:32 six.py
drwxr-xr-x  20 user  staff     680  3 23 14:32 wheel
drwxr-xr-x  11 user  staff     374  3 23 14:32 wheel-0.29.0.dist-info
```

作成したディレクトリーの中の site-packages に NumPy がインストールされたようです。

## virtualenv を無効にする

virtualenv を無効にするには次のコマンドを実行するようです。

> To undo these changes to your path (and prompt), just run:
>
> ``` bash
$ deactivate
```
>
> <cite>[User Guide — virtualenv 15.1.0 documentation](https://virtualenv.pypa.io/en/stable/userguide/)</cite>

無効にしてみます。

``` bash
(ENV) $ deactivate
$
```

プロンプトの最初の `(ディレクトリーの名前)` がなくなりました。

無効な状態のパッケージに影響がないことを確認してみます。

``` bash
$ pip3 list --format=columns
Package    Version
---------- -------
pip        9.0.1
setuptools 32.2.0
virtualenv 15.1.0
wheel      0.29.0
$ ls -l /usr/local/lib/python3.6/site-packages/
total 216
drwxr-xr-x   5 user  admin    170  3 21 19:58 __pycache__
-rw-r--r--   1 user  admin    126 12 23 11:21 easy_install.py
drwxr-xr-x  23 user  admin    782  3 21 19:58 pip
drwxr-xr-x   9 user  admin    306  3 21 19:58 pip-9.0.1-py3.6.egg-info
drwxr-xr-x   6 user  admin    204  3 21 19:58 pkg_resources
drwxr-xr-x  35 user  admin   1190  3 21 19:58 setuptools
drwxr-xr-x   9 user  admin    306  3 21 19:58 setuptools-32.2.0-py3.6.egg-info
-rw-r--r--   1 user  admin   1979  3 21 19:58 sitecustomize.py
drwxr-xr-x  10 user  admin    340  3 21 19:51 virtualenv-15.1.0.dist-info
-rw-r--r--   1 user  admin  99021  3 21 19:51 virtualenv.py
drwxr-xr-x   8 user  admin    272  3 21 19:51 virtualenv_support
drwxr-xr-x  20 user  admin    680  3 21 19:58 wheel
drwxr-xr-x   9 user  admin    306  3 21 19:58 wheel-0.29.0-py3.6.egg-info
```

影響はないみたいでした。

## 終わり

一度調べてしまえばなんてことはないことだと思いますが、新しく覚えることが多くて、なかなか進めることができませんでした。
Python 2 がまだ現役とか知らないですし、ここには記載しませんでしたが、easy_install, setuptools, wheel とか知らないですし、Anaconda とか知らないですし。
基礎をすっ飛ばしても成長はないと思いますので、じっくりやっていきます。

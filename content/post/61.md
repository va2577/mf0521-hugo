+++
date = "2016-12-17T16:45:36+09:00"
draft = true
tags = ["Git"]
title = "Git で差分ファイルを抽出する時にパスにスペースがあるとエラーになる"

+++

Visual Studio の `My Project` フォルダーの中にあるファイルを抽出しようとしてエラーになりましたので、調べてみました。

<!--more-->

## 問題

Visual Studio で開発をしていまして、まだ Subversion を使っていたのですが、Visual Studio が Git をサポートしているので、ようやく最近 Git に移行してみました。

コミットと同期だけするぶんには Visual Studio のチームエクスプローラーからステージしてコミットしたり(一部のファイルだけコミットするステージを覚えました)、同期したりしています。

それから、Subversion を使っていた時によく差分ファイルを抽出していて、同じことができないかと調べていたら、丁寧なブログの記事がありまして、毎回ここからコピペしています。

>
``` bash
$ git archive HEAD `git diff --name-only HEAD~1 HEAD --diff-filter=ACMR` -o archive.zip
```
>
> <cite>[Gitで差分ファイルを抽出+zipファイル化する方法 | 株式会社グランフェアズ](http://www.granfairs.com/blog/staff/git-archivediff)</cite>

ですが、`My Project` フォルダーのところで`fatal: pathspec 'My' did not match any files`のエラーになりました。
`My Project` のスペースで分割されて 2 つのファイルと認識されてしまっているようです。

これに関して、同じような問題を持った人もいるようです。

* [Gitの差分ファイル抽出時にスペースを含んだファイル名でエラー - Qiita](http://qiita.com/gotohiro55/items/24d6696fd59a04751b5b)
* [パスに空白を含むファイルをgit archiveする - foohogehoge's blog](http://foohogehoge.hatenablog.com/entry/20141003/1412340221)
* [git で半角スペースが混ざったファイルを消す方法 | Crunchlog](http://crunchlog.net/internet/net-service/git_rm_fatal/)

が、あまり解決したように見えないです。
対処として、スペースを含むファイルを抽出しないようにしているようですが、それはちょっと採用したくないです。

パスをダブルクォーテーションで囲んでもエラーになります。

>
``` bash
$ git archive --format=zip --prefix=root/ HEAD `git diff --name-only d0b642e 17945a1 | sed 's/\(^.*$\)/"\1"/g'` -o archive.zip
```
>
> <cite>[Gitの差分ファイル抽出時にスペースを含んだファイル名でエラー - Qiita](http://qiita.com/gotohiro55/items/24d6696fd59a04751b5b)</cite>

スペースをバックスラッシュでエスケープしてもエラーになります。

> スペースの前にバックスラッシュが必要なのか？  
> というわけでsedしてみる
>
``` bash
$ git diff --name-only HEAD..HEAD~ | sed -e "s/ /\\\\ /g"
My\ Project/hoge
```
>
> いいんじゃないかな…
>
``` bash
$ git archive --format=zip master `git diff --name-only HEAD..HEAD~ | sed -e "s/ /\\\\ /g"` -o diff.zip
fatal: pathspec 'My' did not match any files
```
>
> 何故じゃ！！  
> 分かる人がいれば教えてください。
>
> <cite>[パスに空白を含むファイルをgit archiveする - foohogehoge's blog](http://foohogehoge.hatenablog.com/entry/20141003/1412340221)</cite>

ただ、`git diff` のところでファイルのパスをとる時にバッククォーテーションを使わないで、ファイルを1つ指定する場合はスペースがあってもダブルクォーテーショーンで囲めば抽出できるようです。

``` bash
$ git archive HEAD "Project/My Project/file.ext" -o archive.zip
```

スペースをバックスラッシュでエスケープもできるようです。

``` bash
$ git archive HEAD Project/My\ Project/file.ext -o archive.zip
```

バックスラッシュのコマンドが怪しそうです。。

## 対処

調べていたら、こちらがヒントになりました。

>
``` bash
git diff --name-status commit1 commit2 | awk '{ if ($1 != "D") print $2 }' | xargs git archive -o output.zip HEAD`
```
>
> <cite>[Git. How to create archive with files, that have been changed? - Stack Overflow](http://stackoverflow.com/questions/7226009/git-how-to-create-archive-with-files-that-have-been-changed)</cite>

抽出対象のファイルのパスをバックスラッシュで入れ子のコマンドから取得しようとしているのがエラーになる原因のようでしたので、パイプを使って抽出対象のファイルのパスを `git archive` コマンドに渡せば良いんじゃないかということです。

前半の `git diff --name-status commit1 commit2 | awk '{ if ($1 != "D") print $2 }'` の部分は `git diff --name-only commit1 commit2 --diff-filter=ACMR` とやりたいことは同じだと解釈しました。
削除したファイル以外の差分のファイルのパスだけをとってきたいのだと思います。
`git diff` だけですむ後者の方が `awk` を使うより良いかなと思います。

次のパイプからは `xargs` がポイントです。

> xargs はしばしばたくさんのシェルのバッククォート機能と同じ機能を持っている。しかし、より柔軟で、入力に空白や特殊文字を含む場合にはしばしばより安全でもある。find、locate や grep のような長いリストを出力するコマンドとともによく使われる。
>
> <cite>[xargs - Wikipedia](https://ja.wikipedia.org/wiki/Xargs)</cite>

`xargs` はバッククォート機能と同じ機能を持っているようです。

`git archive` コマンドを繰り返し実行することになり、非効率的かな？とも思いましたが、そうではなく、`xargs` は "1 度に複数の引数が渡される" ようなので、`git archive` コマンドは 1 回しか実行されないことになり、効率的に実行されるようでした。

## 結果

調べた結果、このコマンドになりました。

``` bash
$ git diff --name-only HEAD~1 HEAD --diff-filter=ACMR | sed -e 's/ /\\\\ /g' | xargs git archive HEAD -o output.zip
```

まず、`git diff` で差分ファイルのパスを取得して、`sed` でスペースをバックスラッシュでエスケープして、`git archive` で抽出しています。

## 対処2

`git archive` ではなく、`git checkout-index` でも抽出することができるようです。

* [Gitで特定のコミット間の差分ファイルをエクスポートする - Qiita](http://qiita.com/tkmiya34/items/50b2b86d144bea388dee)
* [checkout-index | Coffee Breakにプログラミング備忘録](http://to-developer.com/blog/?tag=checkout-index)
* [[Git]コミット間の差分ファイルを取得する方法 | Coffee Breakにプログラミング備忘録](http://to-developer.com/blog/?p=2213)
* [gitでsvn export的なことをやる - Qiita](http://qiita.com/scalper/items/1905b47209989dda5648)
* [Gitでexportするときはgit archiveとgit checkout-indexのどちらがよいか · DQNEO起業日記](http://dqn.sakusakutto.jp/2012/11/git_export_archive_checkout_index.html)

``` bash
$ git diff [oldコミット] [newコミット] --name-only | git checkout-index --prefix=[出力先] --stdin
```

`git checkout-index` は標準入力のオプションがあるので、そのままパイプから `git` コマンドで受けられますが、`git archive` は標準入力のオプションがなさそうでしたので、`xargs` で繰り返しパイプからファイルのパスを受けることになるのだと解釈しました。

`git checkout-index` では圧縮はできないようです。

## 終わり

パスにスペースが含まれることは、まあ、少ないですよね。
自分でファイルを作成したらスペースを含めないと思いますし。
Visual Studio で作成したファイルが My Project フォルダーの下にできたので、エラーになっただけのことですから。。

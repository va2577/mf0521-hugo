<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fixed-Percentage Money Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <!-- <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script> -->
  </head>
  <body>
    <header>
      <section class="hero is-primary">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">
              Fixed-Percentage
            </h1>
            <h2 class="subtitle">
                Money Management (Riot.js)
            </h2>
          </div>
        </div>
      </section>
    </header>

    <main>
      <!-- mount point -->
      <my-tag></my-tag>
    </main>

    <footer class="footer">
      <div class="content has-text-centered">
        <p><a href="https://bulma.io/">Bulma</a></p>
        <p><a href="https://riot.js.org/">Riot.js</a></p>
      </div>
    </footer>

    <!-- inlined tag definition -->
    <script type="riot/tag">
      <my-tag>
        <form>
          <div class="field">
            <label class="label" for="capital">Capital</label>
            <div class="control">
              <input class="input { capitalclass }" id="capital" oninput={ input } placeholder="1000000" ref="capital" type="number" value="{ capital }" min="0" step="100" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="risk">Risk</label>
            <div class="control">
              <input class="input { riskclass }" id="risk" oninput={ input } placeholder="0.01" ref="risk" type="number" value="{ risk }" min="0.00" max="1.00" step="0.01" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="jpy">JPY</label>
            <div class="control">
              <input class="input { jpyclass }" id="jpy" oninput={ input } placeholder="1" ref="jpy" type="number" value="{ jpy }" min="0.00" step="0.01" />
            </div>
          </div>
        </form>
        <table class="table is-fullwidth is-hoverable is-striped">
          <thead>
            <tr>
              <th>Stop-Loss</th>
              <th>Units</th>
              <th>Lots</th>
            </tr>
          </thead>
          <tbody>
            <tr each={ a }>
              <td>{ stopLoss }</td>
              <td>{ units }</td>
              <td>{ lots }</td>
            </tr>
          </tbody>
        </table>
        this.capital = "1000000"
        this.risk = "0.01"
        this.jpy = "1"
        const isNaN_ = s => s.length === 0 || isNaN(s)
        const validate = (capital, risk, jpy) => {
          this.capitalclass = isNaN_(capital) ? 'is-danger' : 'is-success'
          this.riskclass = isNaN_(risk) ? 'is-danger' : 'is-success'
          this.jpyclass = isNaN_(jpy) ? 'is-danger' : 'is-success'
        }
        const calc = (capital, risk, jpy) => {
          const units = x => Math.floor((x.capital * x.risk) / (((x.jpy === 1 ? 0.01 : 0.0001) * x.jpy * x.stopLoss)))
          const lots = x => (Math.floor(x.units / 1000) / 100).toFixed(2)
          const o = {
            'capital': capital,
            'risk': risk,
            'jpy': jpy
          }
          this.a = [...Array(100).keys()]
            .filter(x => x !== 0)
            .map(x => Object.assign({ stopLoss: x }, o))
            .filter(x => !Object.entries(x).some(([key, value]) => isNaN_(value)))
            .map(x => Object.entries(x).map(([key, value]) => ({ [key]: Number(value) })).reduce((acc, cur) => Object.assign(acc, cur), {}))
            .map(x => Object.assign({ units: units(x) }, x))
            .map(x => Object.assign({ lots: lots(x) }, x))
        }
        validate(this.capital, this.risk, this.jpy)
        calc(this.capital, this.risk, this.jpy)
        input(e) {
          validate(this.refs.capital.value, this.refs.risk.value, this.refs.jpy.value)
          calc(this.refs.capital.value, this.refs.risk.value, this.refs.jpy.value)
        }
      </my-tag>
    </script>

    <!-- include riot.js and the compiler -->
    <script src="//cdn.jsdelivr.net/npm/riot@3.13/riot+compiler.min.js"></script>

    <!-- mount normally -->
    <script>
      riot.mount('*')
    </script>
  </body>
</html>
